---
title: "ElectionForecast2020"
author: "Jin Long Cao, Brian Diep, Johnathan Tillman, Tanya Woloshansky"
date: "2/11/2020"
output: pdf_document
---

```{r setup, include=FALSE}

#Import libraries
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(brms)
library(here)
library(skimr)
library(usmap)
library(ggplot2)
library(RColorBrewer)

# Download datasets and run scripts first to get these csv files
census_data <- read_csv("census_data.csv")
survey_data <- read_csv("survey_data.csv")
```


## Keywords
BIDEN, TRUMP, 2020 US ELECTION, FORECASTING, MULTILEVEL REGRESSION WITH POSTSTRATIFICATION

## Abstract

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Introduction

	The 2020 presidential election in America has been hotly discussed throughout the campaign season as the country appears divided on many key issues such as climate change, gun control, handling of the coronavirus, immigration and more. While election polls ideally predict the outcome of the election, information can also be derived regarding how respondents feel about important issues. Data from the Democracy Fund and the UCLA Nationscape was used to produce a model to help understand what demographic factors of respondents predicted their voting. 
	
	
	Using binary logistical regression, key demographic factors such as age, race/ethnicity, income, gender and state showed significantly relation to election outcomes. In particular, voters for Joe Biden were more likely to be younger, female, with income less than a hundred thousand dollars per year and from blue states (states more likely to vote democrat). Older, white males, who made over a hundred thousand dollars per year, were more likely to vote for republican candidate Donald Trump.  Using this model, a simulation was run on data provided by the American Census Survey for 2018. If everyone in the survey were to vote, it would appear as if Joe Biden is the winner (??? Not sure because we havenâ€™t run the simulation but hopeful thinking)

## Data
## Nationscape Data

  The dataset we used for our analysis came from responses to the Nationscape survey. The survey is the result of a partnership between the Democracy Fund Voter Study Group and two Political Scientists at UCLA (Chris Tausanovitch and Lynn Vavreck). The Nationscape survey runs from July 2019 to December 2020, interviewing 6250 people per week for a total of 500,000 respondents. The population of interest for the study is everyone eligible to vote in the US and the population frame are all the respondents sent by the market research platform Lucid to the Nationscape team. The team sampled the respondents sent until a quota on different demographic groups of age, gender, ethnicity, region, income, and education were reached. 

  The individual samples of 6250 respondents were sent directly from Lucid to the Nationscape survey software. Of the 6250 survey invitations sent, only about 75% of those surveys are included in the data as 12% decline immediately. Around 5% of the respondents are omitted because they stop participating during the survey and 8% are removed for speeding through the survey or straight line selecting answers. Lucid also requires an attention check before the survey is conducted and their supply partners that help form samples are evaluated by third party data specialists to ensure accurate representation of the target population..

	The Nationscape team used a simple raking technique to transform their dataset to more accurately represent the US voting population. Raking involves adjusting weights of different demographic groups of a dataset to be proportional to the population of interest. The data is also checked for representativeness in a process used by Pew Research center. To do so, a number of questions are asked which are found on reliable, large scale, government surveys. Estimates from Nationscape surveys are then compared with government surveys, and the difference was in line with that produced by Pew Research.

  When mining for important variables, there were many categories where questions were not asked of all participants. While this is necessary to avoid too many people quitting the survey, some questions had a concrete answer for only 25% of respondents (such as the query regarding Medicare). Another weakness of the survey is that it is only available online and in English, which may deter those who are not comfortable with technology or English. Since the survey is done online, the frame is limited to all Americans that have access to the internet, are reachable online and own a device that is compatible with the software. The survey itself was also only available in English, thus limiting representation from non-native english speakers.
 




```{r race_association, echo = FALSE}
reduced_data <-survey_data
data <- survey_data
ethnicity <-table(data$vote_2020, data$race_ethnicity)
#Create a plot of how ethnicities tend to vote
barplot(ethnicity, cex.names = 0.5, beside=TRUE, main="Respondents Voting Habits By Ethnicity", xlab= "Ethnicity", legend.text = c("Donald Trump", "Joe Biden"), col = c("red", "blue"))
```
```{r genderplot, echo=FALSE}
#Make graph comparing voting habits of male and female voteds
gen_vote<-table(reduced_data$gender, reduced_data$vote_2020)
col = c("red","blue")
barplot(gen_vote, names.arg=c("Donald Trump", "Joe Biden"), beside = TRUE, legend.text = TRUE, col = col, border = "white", main="How Respondents Plan to Vote in 2020 By Gender", ylab="Number of respondents", xlab="Options for 2020 American Election", cex.names = 0.7)
```

```{r ageplot, echo=FALSE}
gen_vote<-table(data$vote_2020, data$age)
barplot(gen_vote, beside = TRUE, legend.text = c("Donald Trump", "Joe Biden"), col = col, border = "white", main="How Respondents Plan to Vote in 2020 By Age Group", ylab="Number of respondents", xlab="Age Groups in Years", cex.names = 0.7)
```

```{r votecompare}
#Filter Data for Donald Trump Voters in 2016
vote_compareD <-filter(data, vote_2016=="Donald Trump")
vote_compareD <-table(vote_compareD$vote_2020)

#Filter Data for Hillary Clinton Voters in 2016
vote_compareHi <-filter(data, vote_2016=="Hillary Clinton")
vote_compareH <-table(vote_compareHi$vote_2020)

par(mfrow = c(1:2))
barplot(vote_compareD, names.arg=c("Donald Trump", "Joe Biden"), col = col, cex.names = 0.7, xlab="Voted for Trump in 2016", legend.text = c("Donald Trump", "Joe Biden"))
barplot(vote_compareH, names.arg=c("Donald Trump", "Joe Biden"), col= col, cex.names = 0.7, xlab="Voted for Clinton in 2016", legend.text = c("Donald Trump", "Joe Biden"))
```
```{r partyassoc, echo=FALSE}
vote_D <-filter(reduced_data, vote_2020=="0")
ideo <-table(vote_D$ideo5)
pie(ideo, main="Political Party Association of Respondents Voting for Donald Trump")
vote_J <-filter(reduced_data, vote_2020=="1")
ideoJ <-table(vote_J$ideo5)

pie(ideo, main="Political Party Association of Respondents Voting for Donald Trump")
pie(ideoJ, main="Political Party Association of Respondents Voting for Joe Biden")

```
```{r income, echo=FALSE}
vote_D <-filter(reduced_data, vote_2020=="0")
vote_J <-filter(reduced_data, vote_2020=="1")
income <-rbind(table(vote_J$household_income), table(vote_D$household_income))
par(las=2)
barplot(income, beside = TRUE, cex.names = 0.50, legend.text = c("Joe Biden", "Donald Trump"), col = c("blue", "red"), main = "Voting Tendencies of Respondents by Income Brackets", ylab="Number of Respondents")

```

```{r, echo=FALSE}
states <-rbind(table(vote_J$state), table(vote_D$state))
par(las=2)
barplot(states, beside = TRUE, cex.names = 0.50, legend.text = c("Joe Biden", "Donald Trump"), col = c("blue", "red"), main = "Voting Tendencies of Respondents by State Brackets", ylab="Number of Respondents")

```

```{r ElectoralVotes, echo=FALSE}
#creates table of states, number of electoral votes for that state, votes for biden and votes for trump
Electoral_votes_by_state <- matrix(c(3,9,6,11,55,9,7,3,3,29,16,4,6,4,20,11,
                                     6,8,8,11,10,4,16,10,10,6,3,15,3,5,4,14,
                                     5,6,29,18,7,7,20,4,9,3,11,38,6,13,3,12,10,5,3),
                                   ncol=1, byrow=TRUE)
rownames(Electoral_votes_by_state) <- c("AK","AL","AR","AZ","CA","CO","CT","DC","DE",
                                        "FL","GA","HI","IA","ID","IL","IN","KS","KY",
                                        "LA","MA","MD","ME","MI","MN","MO","MS","MT",
                                        "NC","ND","NE","NH","NJ","NM","NV","NY","OH",
                                        "OK","OR","PA","RI","SC","SD","TN","TX","UT",
                                        "VA","VT","WA","WI","WV","WY")
colnames(Electoral_votes_by_state) <- "Number of Votes"

votes_for_biden_states <- states[1,]
votes_for_trump_states <- states[2,]

Electoral_votes_by_state <- tibble(Electoral_votes_by_state)
Electoral_votes_by_state <- Electoral_votes_by_state %>% 
  mutate(States = c("AK","AL","AR","AZ","CA","CO","CT","DC","DE",
                                        "FL","GA","HI","IA","ID","IL","IN","KS","KY",
                                        "LA","MA","MD","ME","MI","MN","MO","MS","MT",
                                        "NC","ND","NE","NH","NJ","NM","NV","NY","OH",
                                        "OK","OR","PA","RI","SC","SD","TN","TX","UT",
                                        "VA","VT","WA","WI","WV","WY"), 
         "Number of Votes" = matrix(c(3,9,6,11,55,9,7,3,3,29,16,4,6,4,20,11,
                                     6,8,8,11,10,4,16,10,10,6,3,15,3,5,4,14,
                                     5,6,29,18,7,7,20,4,9,3,11,38,6,13,3,12,10,5,3),
                                   ncol=1, byrow=TRUE),
         "Votes for Biden" = votes_for_biden_states,
         "Votes for Trump" = votes_for_trump_states)


Electoral_votes_by_state <- Electoral_votes_by_state %>% 
  select(States, `Number of Votes`, `Votes for Biden`, `Votes for Trump`)

votes <- Electoral_votes_by_state %>% 
  select(`Number of Votes`, `Votes for Biden`,`Votes for Trump`)

```


```{r CensusAnalysis, echo=FALSE}
census_data %>% 
  ggplot(aes(x=state)) +
  geom_bar(fill='red', color='black')+
  theme(axis.text.x=element_text(angle=90),panel.background = element_rect(fill = "lightblue", colour = "lightblue", size = 0.5, linetype = "solid")) +
  labs(x="States",
       y="Number of Respondents",
       title="Population in Each State")


census_data %>% 
  ggplot(aes(x=gender)) +
  geom_bar(fill='red', color='black')+
  theme(panel.background = element_rect(fill = "lightblue", colour = "lightblue", size = 0.5, linetype = "solid")) +
  labs(x="Gender",
       y="Number of Respondents",
       title="Gender Proportion in Census data")


census_data %>% 
  ggplot(aes(x=age)) +
  geom_bar(fill='red', color='black')+
  theme(panel.background = element_rect(fill = "lightblue", colour = "lightblue", size = 0.5, linetype = "solid")) +
  labs(x="Age range",
       y="Number of Respondents",
       title="Age range in the US")


pie(table(census_data$race_ethnicity), main = "Ethnicity")

census_data %>% 
  ggplot(aes(x=hispanic)) +
  geom_bar(fill='red', color='black')+
  theme(panel.background = element_rect(fill = "lightblue", colour = "lightblue", size = 0.5, linetype = "solid")) +
  labs(x="Hispanic",
       y="Number of Respondents",
       title="Hispanic Proportion in Census data")

pie(table(census_data$employment), main = "Employment Status")

pie(table(census_data$household_income), main = "Household income")
```


## Model
```{r model, echo=FALSE}

# Fit Bayesian model
model_states <- brm(vote_2020 ~ gender + age + household_income +
                    race_ethnicity + hispanic + employment,
                    data = survey_data,
                    family = bernoulli(),
                    file = "outputs/model/brms_model_states8",
                    chains=6
                    )

model <- read_rds("outputs/model/brms_model_states8.rds")

# Increase memory allocated to R
memory.limit(size=80000)

pop_vote <- plyr::count(census_data, c("state", "gender", "age",
                                       "race_ethnicity", "hispanic",
                                       "household_income", "employment"))

# Do post stratification
pop_vote <- pop_vote %>%
  group_by(state) %>%
  mutate(prop = freq / sum(freq)) %>%
  ungroup()

post_stratified_estimates <- model %>%
  tidybayes::add_predicted_draws(newdata=pop_vote) %>%
  rename(biden_predict =.prediction) %>%
  mutate(biden_predict_prop =biden_predict*prop) %>%
  group_by(state, .draw) %>%
  summarise(biden_predict =sum(biden_predict_prop)) %>%
  group_by(state) %>%
  summarise(mean =mean(biden_predict),
            lower = quantile(biden_predict, 0.025),
            upper = quantile(biden_predict, 0.975))

# Winner takes all, convert all > 0.5 Biden vote predictions into binary
# response
post_stratified_estimates <- post_stratified_estimates %>%
  mutate(winner = ifelse(mean > 0.5, 1, 0))
```


## Results

```{r graph_confidence_intervals compared to raw data, echo=FALSE, fig.height=6, fig.width=16}

# Clean raw data to be graphed
a <- survey_data %>%
  group_by(state, vote_2020) %>%
  summarise(n = n())

a <- a %>% group_by(state) %>%
  mutate(prop = n/sum(n))

a <- a %>% 
  filter(vote_2020 == 1)

post_stratified_estimates %>%
  ggplot(aes(y = mean, x = forcats::fct_inorder(state), color = "MRP estimate")) +
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) +
  ylab("Proportion voting for Biden") +
  xlab("State") +
  geom_point(data = a, aes(y = prop, x = forcats::fct_inorder(state), color = "Raw data")) +
  scale_color_manual(name = "", values = c("MRP estimate" = "black", "Raw data" = "red")) +
  geom_hline(yintercept=0.5, linetype="dashed", color = "steel blue")
  theme_bw(base_size = 14) +
  ggtitle("Figure X: Proportion of Votes for Biden by State")

```

```{r WinElectoralVotes, echo=FALSE}
#This chunk of code goes through the Electoral_votes_by_state data and sees who wins that state's electoral votes

#creates table of states, number of electoral votes for that state, votes for biden and votes for trump
Electoral_votes_by_state <- matrix(c(3,9,6,11,55,9,7,3,3,29,16,4,6,4,20,11,
                                     6,8,8,11,10,4,16,10,10,6,3,15,3,5,4,14,
                                     5,6,29,18,7,7,20,4,9,3,11,38,6,13,3,12,10,5,3),
                                   ncol=1, byrow=TRUE)
rownames(Electoral_votes_by_state) <- c("AK","AL","AR","AZ","CA","CO","CT","DC","DE",
                                        "FL","GA","HI","IA","ID","IL","IN","KS","KY",
                                        "LA","MA","MD","ME","MI","MN","MO","MS","MT",
                                        "NC","ND","NE","NH","NJ","NM","NV","NY","OH",
                                        "OK","OR","PA","RI","SC","SD","TN","TX","UT",
                                        "VA","VT","WA","WI","WV","WY")
colnames(Electoral_votes_by_state) <- "Number of Votes"

x <- 1
Biden_votes = 0
Trump_votes = 0

while (x<52) {
  ifelse(post_stratified_estimates$winner[x] == 1,
         Biden_votes <- 
           Biden_votes + Electoral_votes_by_state[x],
         Trump_votes <- 
           Trump_votes + Electoral_votes_by_state[x])
  x = x+1
}

#Who ever gets 270 or more electoral votes win
```

```{r electoral map, echo=FALSE}
statebins::statebins(state_data = post_stratified_estimates, state_col = "state",
                     value_col = "mean", brew_pal = "Blues") + theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),legend.position="none",
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank())
```

```{r electoral map winners, echo=FALSE}

# Graph electoral college
electoral_map <- post_stratified_estimates %>%
  mutate(value = ifelse(winner == 0, "Trump", "Biden")) %>%
  statebins::statebins(font_size=4, dark_label = "white", light_label = "white",
    ggplot2_scale_function = scale_fill_manual,
    name = "Winner",
    values = c(Biden = "#2166ac", Trump = "#b2182b")) + theme(
      panel.background=element_blank(), axis.line=element_blank(),
      axis.text.x=element_blank(), axis.text.y=element_blank(),
      axis.ticks=element_blank(), axis.title.x=element_blank(),
      axis.title.y=element_blank()
    ) +
  labs(title="Figure X: 2020 US Election Electoral College Predictions")

electoral_map
```
```{r}

```


## Discussion

## References
